[%- USE LxERP -%][%- USE L -%][%- USE HTML -%][%- USE JavaScript -%][% USE Base64 %]
[% SET style="width: 500px" %]
[% SET id_base_bak  = "fileupload" %]
[% SET id_base      = 'fileupload_' _ (SELF.file.id ? SELF.file.id : 'new') %]
[% SET trans_id     = SELF.file.id ? SELF.file.trans_id : data.trans_id %]
[% SET modul        = SELF.file.id ? SELF.file.modul : data.modul %]

<form method="post" id="fileupload_form" method="POST" enctype="multipart/form-data">
 [% L.hidden_tag('form_prefix',                    id_base,      id=id_base _ '_form_prefix') %]
 [% L.hidden_tag(id_base _ '.id',                  SELF.file.id, no_id=1) %]
 [% L.hidden_tag(id_base _ '.trans_id',            trans_id) %]
 [% L.hidden_tag(id_base _ '.modul',               modul) %]
 [% L.hidden_tag('aft',                            data.aft) %]

 <h2>
  [%- IF SELF.file.id %]
   [%- LxERP.t8("Edit file properties ", SELF.file.position) %]
  [%- ELSE %]
   [%- LxERP.t8("Add file") %]
  [%- END %]
 </h2>

 <table>
[% IF SELF.file.id %]
  <tr>
   <th align="right">[%- LxERP.t8("Position") %]:</th>
   <td>[% HTML.escape(SELF.file.position) %]</td>
  </tr>
[% END %]

  <tr>
   <th align="right">[%- LxERP.t8("Description") %]:</th>
   <td>[% L.input_tag(id_base _ '.description', SELF.file.description, style=style) %]</td>
  </tr>

  <tr>
   <th align="right">[%- LxERP.t8("Title") %]:</th>
   <td>[% L.input_tag(id_base _ '.title', SELF.file.title, style=style) %]</td>
  </tr>

[% IF SELF.file.file_content %]
  <tr>
   <th align="right">[%- LxERP.t8("File name") %]:</th>
   <td>[% HTML.escape(SELF.file.filename) %][% L.hidden_tag(id_base _ '.filename', SELF.file.filename) %][% L.hidden_tag('id', SELF.file.id, no_id=1) %]</td>
  </tr>

  <tr>
   <th align="right">[%- LxERP.t8("MIME type") %]:</th>
   <td>[% HTML.escape(SELF.file.file_content_type) %]</td>
  </tr>

  <tr>
   <th align="right">[%- LxERP.t8("Dimensions") %]:</th>
   <td>[% HTML.escape(SELF.file.files_img_width) %]x[% HTML.escape(SELF.file.files_img_height) %]</td>
  </tr>

  <tr>
   <th align="right">[%- LxERP.t8("Uploaded at") %]:</th>
   <td>[% HTML.escape(SELF.file.files_mtime.to_kivitendo(precision='second')) %]</td>
  </tr>
[% END %]

  <tr>
   <th align="right">[%- LxERP.t8("Select file to upload") %]:</th>
   <td>[% L.input_tag(id_base _ '.file_content', '', type='file') %]</td>
  </tr>
 </table>

 <p>
 <!-- TODO action ändern in übergebene Variable, sodass jede xbelibiege Controller/Action aufgerufen werden kann -->
  [%- L.ajax_submit_tag('controller.pl?action=' _ data.ca, '#fileupload_form', LxERP.t8('Save'), no_id=1) %]
  <a href="#" onclick="$('#jqueryui_popup_dialog').dialog('close');">[%- LxERP.t8("Cancel") %]</a>
 </p>

</form>

[% IF SELF.file.id %]
<h2>[% LxERP.t8("Current file") %]</h2>

<div>
 <img src="data:[% HTML.escape(SELF.file.file_content_type) %];base64,[% SELF.file.file_content.encode_base64 %]">
</div>
[% END %]
