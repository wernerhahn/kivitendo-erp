[%- USE T8 %]
[%- USE HTML %]
[%- USE LxERP %]
[%- USE L %]

[%- INCLUDE 'generic/set_longdescription.html' %]

<div id="ui-tabs-basic-data">
  <table width="100%">
    <tr valign="top">
      <td>
        <table width="100%">
          <tr>
            <th align="right">[% SELF.cv | $T8 %]</th>
            [% SET cv_id = SELF.cv _ '_id' %]
            <td>[% L.customer_vendor_picker("order.${SELF.cv}" _ '_id', SELF.order.$cv_id, type=SELF.cv, style='width: 300px') %]</td>
          </tr>

          <tr id='cp_row' [%- IF !SELF.order.${SELF.cv}.contacts.size %]style='display:none'[%- END %]>
            <th align="right">[% 'Contact Person' | $T8 %]</th>
            <td>[% L.select_tag('order.cp_id',
                                SELF.order.${SELF.cv}.contacts,
                                default=SELF.order.cp_id,
                                title_key='full_name_dep',
                                value_key='cp_id',
                                with_empty=1,
                                style='width: 300px') %]</td>
          </tr>

          <tr id='shipto_row' [%- IF !SELF.order.${SELF.cv}.shipto.size %]style='display:none'[%- END %]>
            <th align="right">[% 'Shipping Address' | $T8 %]</th>
            <td>[% L.select_tag('order.shipto_id',
                                SELF.order.${SELF.cv}.shipto,
                                default=SELF.order.shipto_id,
                                title_key='displayable_id',
                                value_key='shipto_id',
                                with_empty=1,
                                style='width: 300px') %]</td>
          </tr>

          <tr>
            <th align="right">[% 'Steuersatz' | $T8 %]</th>
            <td>[% L.select_tag('order.taxzone_id', SELF.all_taxzones, default=SELF.order.taxzone_id, title_key='description', style='width: 300px', class='recalc') %]</td>
          </tr>

[%- IF SELF.all_departments.size %]
          <tr>
            <th align="right">[% 'Department' | $T8 %]</th>
            <td>
              [% L.select_tag('order.department_id', SELF.all_departments, default=SELF.order.department_id, title_key='description', with_empty=1, style='width:300px') %]
            </td>
          </tr>
[%- END %]

          <tr>
            <th align="right">[% 'Shipping Point' | $T8 %]</th>
            <td>[% L.input_tag('order.shippingpoint', SELF.order.shippingpoint, style='width: 300px') %]</td>
          </tr>

          <tr>
            <th align="right">[% 'Ship via' | $T8 %]</th>
            <td>[% L.input_tag('order.shipvia', SELF.order.shipvia, style='width: 300px') %]</td>
          </tr>

          <tr>
            <th align="right">[% 'Transaction description' | $T8 %]</th>
            <td>[% L.input_tag('order.transaction_description', SELF.order.transaction_description, style='width: 300px') %]</td>
          </tr>

          <tr>
            <th align="right">[% 'Project Number' | $T8 %]</th>
            <td>[% L.project_picker('order.globalproject_id', SELF.order.globalproject_id, style='width: 300px') %]</td>
          </tr>

        </table>
      </td>

      <td align="right">
        <table>

          <tr>
            <td colspan="2" align="center">
              [%- IF SELF.order.id %]
                <label for="order.delivered">[% 'Delivery Order(s) for full qty created' | $T8 %]</label>
                [% L.yes_no_tag('order.delivered', SELF.order.delivered) %]
                <label for="order.closed">[% 'Closed' | $T8 %]</label>
                [% L.yes_no_tag('order.closed', SELF.order.closed) %]
              [%- END %]
            </td>
          </tr>

          <tr>
            <th align="right">[% 'Employee' | $T8 %]</th>
            <td>[% L.select_tag('order.employee_id',
              SELF.all_employees,
              default=(SELF.order.employee_id ? SELF.order.employee_id : SELF.current_employee_id),
              title_key='safe_name') %]</td>
          </tr>

          [% IF SELF.cv == 'customer' %]
          <tr>
            <th align="right">[% 'Salesman' | $T8 %]</th>
            <td>[% L.select_tag('order.salesman_id',
              SELF.all_salesmen,
              default=(SELF.order.salesman_id ? SELF.order.salesman_id : SELF.current_employee_id),
              title_key='safe_name') %]</td>
          </tr>
          [% END %]

          <tr>
            <th width="70%" align="right" nowrap>[% 'Order Number' | $T8 %]</th>
            <td>[% L.input_tag('order.ordnumber', SELF.order.ordnumber, size = 11) %]</td>
          </tr>

          <tr>
            <th width="70%" align="right" nowrap>[% 'Quotation Number' | $T8 %]</th>
            <td>[% L.input_tag('order.quonumber', SELF.order.quonumber, size = 11) %]</td>
          </tr>

          <tr>
            <th width="70%" align="right" nowrap>[% 'Customer Order Number' | $T8 %]</th>
            <td>[% L.input_tag('order.cusordnumber', SELF.order.cusordnumber, size = 11) %]</td>
          </tr>

          <tr>
            <th width="70%" align="right" nowrap>[% 'Order Date' | $T8 %]</th>
            <td>[% L.date_tag('order.transdate', SELF.order.transdate) %]</td>
          </tr>

          <tr>
            <th width="70%" align="right" nowrap>[% 'Reqdate' | $T8 %]</th>
            <td>[% L.date_tag('order.reqdate', SELF.order.reqdate) %]</td>
          </tr>

          <tr>
            <th width="70%" align="right" nowrap>[% 'Insert Date' | $T8 %]</th>
            <td>[% SELF.order.itime_as_date %]</td>
          </tr>

        </table>

      </td>
    </tr>
  </table>

  [%- PROCESS order/tabs/_item_input.html %]

  [% L.button_tag('show_multi_items_dialog()', LxERP.t8('Add multiple items')) %]</td>

  <table width="100%">
    <tr>
      <td>

        <div id="row_table_scroll_id" style="overflow-y: auto; height: 25vh">
          <table id="row_table_id" width="100%">
            <thead>
              <tr class="listheading">
                <th class="listheading" style='display:none'></th>
                <th class="listheading" nowrap width="3" >[%- 'position'     | $T8 %] </th>
                <th class="listheading" style='text-align:center' nowrap width="1"><img src="image/updown.png" alt="[%- LxERP.t8('reorder item') %]"></th>
                <th class="listheading" style='text-align:center' nowrap width="1"><img src="image/close.png" alt="[%- LxERP.t8('delete item') %]"></th>
                <th id="partnumber_header_id"  class="listheading" nowrap width="15"><a href='#' onClick='javascript:reorder_items("partnumber")'> [%- 'Partnumber'  | $T8 %]</a></th>
                <th id="description_header_id" class="listheading" nowrap           ><a href='#' onClick='javascript:reorder_items("description")'>[%- 'Description' | $T8 %]</a></th>
                <th id="qty_header_id"         class="listheading" nowrap width="5" ><a href='#' onClick='javascript:reorder_items("qty")'>        [%- 'Qty'         | $T8 %]</a></th>
                <th class="listheading" nowrap width="5" >[%- 'Price Factor' | $T8 %] </th>
                <th class="listheading" nowrap width="5" >[%- 'Unit'         | $T8 %] </th>
                <th class="listheading" nowrap width="5" >[%- 'Price Source' | $T8 %] </th>
                <th id="sellprice_header_id"   class="listheading" nowrap width="15" ><a href='#' onClick='javascript:reorder_items("sellprice")'> [%- 'Price'       | $T8 %]</a></th>
                <th id="discount_header_id"    class="listheading" nowrap width="15" ><a href='#' onClick='javascript:reorder_items("discount")'>  [%- 'Discount'    | $T8 %]</a></th>
                <th class="listheading" nowrap width="10">[%- 'Extended'     | $T8 %] </th>
              </tr>
            </thead>

            [%- FOREACH item = SELF.order.items_sorted %]
              [%- PROCESS order/tabs/_row.html ITEM=item ID=item.id %]
            [%- END %]

          </table>
        </div>

      </td>
    </tr>

    <tr>
    </tr>

    <tr>
      <td colspan="100%" width="100%">
        <table width="100%">
          <tr>
            <td>
              <table>
                <tr>
                  <th align="left">[% 'Notes' | $T8 %]</th>
                  <th align="left">[% 'Internal Notes' | $T8 %]</th>
                </tr>
                <tr valign="top">
                  <td>
                    [% L.textarea_tag('order.notes', SELF.order.notes, wrap="soft", style="width: 350px; height: 150px", class="texteditor") %]
                  </td>
                  <td>
                    [% L.textarea_tag('order.intnotes', SELF.order.intnotes, wrap="soft", style="width: 350px; height: 150px") %]
                  </td>
                </tr>
              </table>
            </td>

            <td>
              <table>
                <tr>
                  <th align="right">[% 'Payment Terms' | $T8 %]</th>
                  <td>[% L.select_tag('order.payment_id',
                                      SELF.all_payment_terms,
                                      default = SELF.order.payment_id,
                                      with_empty = 1,
                                      title_key = 'description',
                                      style = 'width: 250px') %]</td>
                </tr>
                <tr>
                  <th align="right">[% 'Delivery Terms' | $T8 %]</th>
                  <td>[% L.select_tag('order.delivery_term_id',
                                      SELF.all_delivery_terms,
                                      default = SELF.order.delivery_term_id,
                                      with_empty = 1,
                                      title_key = 'description',
                                      style = 'width: 250px') %]</td>
                </tr>
              </table>
            </td>

            <td align="right">
              <table>
                <tr id="taxincluded_row_id" [%- IF !SELF.taxes.size %]style="display:none"[%- END %]>
                  <td align=right colspan="2">
                    <label for="order.taxincluded"><b>[% 'Tax Included' | $T8 %]</b></label>
                    [% L.yes_no_tag('order.taxincluded', SELF.order.taxincluded, class='recalc') %]
                  </td>
                </tr>

                <tr id="subtotal_row_id" [%- IF SELF.order.taxincluded %]style="display:none"[%- END %]>
                  <th align="right">[%- 'Subtotal' | $T8 %]</th>
                  <td align="right">
                    [%- L.div_tag(SELF.order.netamount_as_number, id='netamount_id') %]
                  </td>
                </tr>
                [%- FOREACH tax = SELF.taxes %]
                  [%- PROCESS order/tabs/_tax_row.html TAX=tax TAXINCLUDED=SELF.order.taxincluded %]
                [%- END %]
                <tr id="amount_row_id">
                  <th align="right">[%- 'Total' | $T8 %]</th>
                  <td align="right">
                    [%- L.div_tag(SELF.order.amount_as_number, id='amount_id') %]
                  </td>
                </tr>
              </table>
            </td>

          </tr>
        </table>
      </td>
    </tr>

  </table>

</div>


[% L.sortable_element('#row_table_id') %]

<script type='text/javascript'>
function reload_cv_dependend_selections() {
  var data = $('#order_form').serializeArray();
  data.push({ name: 'action', value: 'Order/customer_vendor_changed' });

  $.post("controller.pl", data, kivi.eval_json_result);
}

function unit_change(event) {
  var row = $(event.target).parents("tbody").first();
  var item_id_dom = $(row).find('[name="orderitem_ids[+]"]');
  var sellprice_dom = $(row).find('[name="order.orderitems[].sellprice_as_number"]');
  var select_elt = $(row).find('[name="order.orderitems[].unit"]');

  var oldval = $(select_elt).data('oldval');
  $(select_elt).data('oldval', $(select_elt).val());

  var data = $('#order_form').serializeArray();
  data.push({ name: 'action', value: 'Order/unit_changed' });
  data.push({ name: 'item_id', value: item_id_dom.val() });
  data.push({ name: 'old_unit', value: oldval });
  data.push({ name: 'sellprice_dom_id', value: sellprice_dom.attr('id') });

  $.post("controller.pl", data, kivi.eval_json_result);
}

function update_sellprice(item_id, price_str) {
  var row = $('#item_' + item_id).parents("tbody").first();
  var price_elt = $(row).find('[name="order.orderitems[].sellprice_as_number"]');
  var html_elt  = $(row).find('[name="sellprice_text"]');
  price_elt.val(price_str);
  html_elt.html(price_str);
}

function add_item() {
  if ($('#add_item_parts_id').val() == '') return;
  if (!check_cv()) return;

  $('#row_table_id thead a img').remove();

  var data = $('#order_form').serializeArray();
  data.push({ name: 'action', value: 'Order/add_item' });

  $.post("controller.pl", data, kivi.eval_json_result);
}

function show_multi_items_dialog() {
  if (!check_cv()) return;

  $('#row_table_id thead a img').remove();

  kivi.popup_dialog({
    url: 'controller.pl?action=Order/show_multi_items_dialog',
    data: { type: $('#type').val(),
            callback: 'Order/add_multi_items',
            callback_data_id: 'order_form' },
    id: 'jq_multi_items_dialog',
    dialog: {
      title: kivi.t8('Add multiple items'),
      width:  800,
      height: 500
    }
  });
  return true;
}

function close_multi_items_dialog() {
  $('#jq_multi_items_dialog').dialog('close');
};

function delete_order_item_row(clicked) {
  var row = $(clicked).parents("tbody").first();
  $(row).remove();

  renumber_positions();
  recalc_amounts_and_taxes();
}

function price_chooser_item_row(clicked) {
  var row = $(clicked).parents("tbody").first();
  var item_id_dom = $(row).find('[name="orderitem_ids[+]"]');

  var data = $('#order_form').serializeArray();
  data.push({ name: 'action', value: 'Order/price_popup' });
  data.push({ name: 'item_id', value: item_id_dom.val() });

  $.post("controller.pl", data, kivi.eval_json_result);
}

function update_price_source(item_id, source, descr, price_str) {
  var row = $('#item_' + item_id).parents("tbody").first();
  var source_elt = $(row).find('[name="order.orderitems[].active_price_source"]');
  var button_elt = $(row).find('[name="price_chooser_button"]');

  button_elt.val(button_elt.val().replace(/.*\|/, descr + " |"));
  source_elt.val(source);

  var editable_div_elt = $(row).find('[name="editable_price"]');
  var not_editable_div_elt = $(row).find('[name="not_editable_price"]');
  if ([%- AUTH.assert('edit_prices', 1) %] == 1 && source == '') {
    // editable
    $(editable_div_elt).show();
    $(not_editable_div_elt).hide();
    $(editable_div_elt).find(':input').prop("disabled", false);
    $(not_editable_div_elt).find(':input').prop("disabled", true);
  } else {
    // not editable
    $(editable_div_elt).hide();
    $(not_editable_div_elt).show();
    $(editable_div_elt).find(':input').prop("disabled", true);
    $(not_editable_div_elt).find(':input').prop("disabled", false);
  }

  if (price_str) {
    var price_elt = $(row).find('[name="order.orderitems[].sellprice_as_number"]');
    var html_elt  = $(row).find('[name="sellprice_text"]');
    price_elt.val(price_str);
    html_elt.html(price_str);
    recalc_amounts_and_taxes();
  }

  kivi.io.close_dialog();
}

function update_discount_source(item_id, source, descr, discount_str) {
  var row = $('#item_' + item_id).parents("tbody").first();
  var source_elt = $(row).find('[name="order.orderitems[].active_discount_source"]');
  var button_elt = $(row).find('[name="price_chooser_button"]');

  button_elt.val(button_elt.val().replace(/\|.*/, "| " + descr));
  source_elt.val(source);

  var editable_div_elt = $(row).find('[name="editable_discount"]');
  var not_editable_div_elt = $(row).find('[name="not_editable_discount"]');
  if ([%- AUTH.assert('edit_prices', 1) %] == 1 && source == '') {
    // editable
    $(editable_div_elt).show();
    $(not_editable_div_elt).hide();
    $(editable_div_elt).find(':input').prop("disabled", false);
    $(not_editable_div_elt).find(':input').prop("disabled", true);
  } else {
    // not editable
    $(editable_div_elt).hide();
    $(not_editable_div_elt).show();
    $(editable_div_elt).find(':input').prop("disabled", true);
    $(not_editable_div_elt).find(':input').prop("disabled", false);
  }

  if (discount_str) {
    var discount_elt = $(row).find('[name="order.orderitems[].discount_as_percent"]');
    var html_elt     = $(row).find('[name="discount_text"]');
    discount_elt.val(discount_str);
    html_elt.html(discount_str);
    recalc_amounts_and_taxes();
  }

  kivi.io.close_dialog();
}

function reformat_number(event) {
  $(event.target).val(kivi.format_amount(kivi.parse_amount($(event.target).val()), -2));
}

function recalc_amounts_and_taxes() {
  var data = $('#order_form').serializeArray();
  data.push({ name: 'action', value: 'Order/recalc_amounts_and_taxes' });

  $.post("controller.pl", data, kivi.eval_json_result);
}

function redisplay_linetotals(data) {
  $('.row_entry [name="linetotal"]').each(function(idx, elt) {
    $(elt).html(data[idx]);
  });
}

function row_table_scroll_down() {
  $('#row_table_scroll_id').scrollTop($('#row_table_scroll_id')[0].scrollHeight);
}

function row_set_keyboard_events_by_id(item_id) {
  var row = $('#item_' + item_id).parents("tbody").first();

  row_set_keyboard_events(row);
}

function row_set_keyboard_events(rows) {
  $(rows).keydown(function(event) {
    if(event.keyCode == 40 && event.shiftKey == true) {
      // shift arrow down
      event.preventDefault();
      var row = $(event.target).parents(".row_entry").first();
      $(row).children().not(':first').show();
      return false;
    }
    if(event.keyCode == 38 && event.shiftKey == true) {
      // shift arrow up
      event.preventDefault();
      var row = $(event.target).parents(".row_entry").first();
      $(row).children().not(':first').hide();
      return false;
    }
  });

  $(rows).dblclick(function(event) {
      event.preventDefault();
      var row = $(event.target).parents(".row_entry").first();
      $(row).children().not(':first').toggle();
      return false;
  });
}

function set_unit_change_with_oldval_by_id(item_id) {
  var row = $('#item_' + item_id).parents("tbody").first();
  var select_elt = $(row).find('[name="order.orderitems[].unit"]');

  set_unit_change_with_oldval(select_elt);
}

function set_unit_change_with_oldval(selects) {
  selects.data('oldval', selects.val());

  selects.change(unit_change);
}

var email_dialog;

function show_email_dialog(html) {
  var id            = 'jqueryui_popup_dialog';
  var dialog_params = {
    id:     id,
    width:  800,
    height: 500,
    modal:  true,
    close: function(event, ui) {
      email_dialog.remove();
    },
  };

  $('#' + id).remove();

  email_dialog = $('<div style="display:none" id="' + id + '"></div>').appendTo('body');
  email_dialog.html(html);
  email_dialog.dialog(dialog_params);

  $('.cancel').click(close_email_dialog);

  return true;
}

close_email_dialog = function() {
  email_dialog.dialog("close");
}

function renumber_positions() {
  $('.row_entry [name="position"]').each(function(idx, elt) {
    $(elt).html(idx+1);
  });
}

function reorder_items(order_by) {
  var dir = $('#' + order_by + '_header_id a img').attr("data-sort-dir");
  $('#row_table_id thead a img').remove();

  var src;
  if (dir == "1") {
    dir = "0";
    src = "image/up.png";
  } else {
    dir = "1";
    src = "image/down.png";
  };

  $('#' + order_by + '_header_id a').append('<img border=0 data-sort-dir=' + dir + ' src=' + src + ' alt="[%- LxERP.t8('sort items') %]">');

  var data = $('#order_form').serializeArray();
  data.push({ name: 'action', value: 'Order/reorder_items' });
  data.push({ name: 'order_by', value: order_by });
  data.push({ name: 'sort_dir', value: dir });

  $.post("controller.pl", data, kivi.eval_json_result);
}

function redisplay_items(data) {
  var old_rows = $('.row_entry').detach();
  var new_rows = [];
  $(data).each(function(idx, elt) {
    new_rows.push(old_rows[elt.old_pos - 1]);
  });
  $(new_rows).appendTo($('#row_table_id'));
  renumber_positions();
}

function show_longdescription_dialog(clicked) {
  var row = $(clicked).parents("tbody").first();
  var position = $(row).find('[name="position"]').html();
  var partnumber = $(row).find('[name="partnumber"]').html();
  var description_elt = $(row).find('[name="order.orderitems[].description"]');
  var description = description_elt.val();
  var longdescription_elt = $(row).find('[name="order.orderitems[].longdescription"]');
  var longdescription;

  if (!longdescription_elt.length) {
    var data = [];
    data.push({ name: 'action', value: 'Order/get_item_longdescription' });
    data.push({ name: 'type', value: $('#type').val() });
    data.push({ name: 'item_id', value: $(row).find('[name="order.orderitems[+].id"]').val() });
    data.push({ name: 'parts_id', value: $(row).find('[name="order.orderitems[].parts_id"]').val() });
    $.ajax({
      url: 'controller.pl',
      data: data,
      method: "GET",
      async: false,
      dataType: 'text',
      success: function(val){
        longdescription = val;
      }
    });
  } else {
    longdescription = longdescription_elt.val();
  }

  var params = { runningnumber: position,
                 partnumber: partnumber,
                 description: description,
                 default_longdescription: longdescription,
                 set_function: function(val){
                   longdescription_elt.remove();
                   $('<input type="hidden" name="order.orderitems[].longdescription">').insertAfter(description_elt).val(val);
                 }
               };

  kivi.SalesPurchase.edit_longdescription_with_params(params);
}

$(function(){
  $('#order_[%- cv_id %]').change(reload_cv_dependend_selections);
  [%- IF SELF.cv == 'customer' %]
    $('#add_item_parts_id').on('set_item:PartPicker', function(e,o) { $('#add_item_sellprice_as_number').val(kivi.format_amount(o.sellprice, -2)) });
  [%- ELSE %]
    $('#add_item_parts_id').on('set_item:PartPicker', function(e,o) { $('#add_item_sellprice_as_number').val(kivi.format_amount(o.lastcost, -2)) });
  [%- END %]
  $('#add_item_parts_id').on('set_item:PartPicker', function(e,o) { $('#add_item_description').val(o.description) });
  $('#add_item_parts_id').on('set_item:PartPicker', function(e,o) { $('#add_item_unit').val(o.unit) });
  $('.add_item_input').keydown(function(event) {
    if(event.keyCode == 13) {
      event.preventDefault();
      add_item();
      return false;
    }
  });
  row_set_keyboard_events($('.row_entry'));
  $('.recalc').change(recalc_amounts_and_taxes);
  $('.reformat_number').change(reformat_number);

  set_unit_change_with_oldval($('.unitselect'));
});

$('#row_table_id').on('sortstop', function(event, ui) {
  $('#row_table_id thead a img').remove();
  renumber_positions();
});
</script>
